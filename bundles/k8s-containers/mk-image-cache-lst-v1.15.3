#!/bin/sh
#
# Copyright 2015-2017 Docker, Inc.
# https://github.com/linuxkit/kubernetes/blob/master/LICENSE
#
# Pretty much copy pasted with some tweaks for weave-kube from:
#
#   https://github.com/linuxkit/kubernetes/blob/master/scripts/mk-image-cache-lst
#

set -e

common="
	KUBE_PROXY_V11512
	PAUSE_31
	COREDNS_131
	WEAVE_KUBE_270
	WEAVE_NPC_270
	WEAVEEXEC_270
	REGISTRY_262
	ENVOY_V1100
	CONTOUR_V0130
	ROOK_CEPH_103
	ROOK_CEPH_106
	CEPH_1420
	CEPH_1422
	REPLICATED_HOSTPATH_PROVISIONER
	K8S_DNS_NODE_CACHE_11513"

control="
	KUBE_APISERVER_V11512
	KUBE_CONTROLLER_MANAGER_V11512
	KUBE_SCHEDULER_V11512
	ETCD_3310
	ETCD_347"

oi() {
	local i="$1"
	digest=$(docker image inspect --format '{{index .RepoDigests 0}}' "${i}")
	echo "${i}@${digest#*@}"
}

list() {
	echo "# autogenerated by:"
	echo "#    $0 $@"
	for i in $@ ; do
		oi "$i"
	done
}

tag() {
	for i in $@ ; do
		id="$(docker image inspect --format '{{.Id}}' "${i}")"
		echo "docker tag ${id:7:12} ${i}"
	done
}

if [ $# -lt 1 ] ; then
    echo >&2 "Need exactly one of \`control-plane' or \`common'"
    exit 1
fi

case $1 in
    common)        pkgids="$common" ;;
    control-plane) pkgids="$control" ;;
esac

pkgs=
for pkgid in $pkgids ; do
	pkgs=$pkgs" $(cat ../../Manifest | grep $pkgid | awk '{print $2}')"
done

for i in $pkgs ; do
	docker image pull "$i" 1>&2
done

case $2 in
    tag) tag $pkgs ;;
    *)   list $pkgs ;;
esac
