#!/bin/sh
#
# Copyright 2015-2017 Docker, Inc.
# https://github.com/linuxkit/kubernetes/blob/master/LICENSE
#
# Pretty much copy pasted with some tweaks for weave-kube from:
#
#   https://github.com/linuxkit/kubernetes/blob/master/scripts/mk-image-cache-lst
#

set -e

repo=k8s.gcr.io
kubernetes_version=v1.15.3
pause_version=3.1
etcd_version=3.3.10
coredns_version=1.3.1
weave_version=2.5.2
registry_version=2.6.2
envoy_version=v1.10.0
contour_version=v0.13.0
rook_103_version=v1.0.3
rook_106_version=v1.0.6
ceph_103_version=v14.2.0-20190410
ceph_106_version=v14.2.8-20200305
replicated_hostpath_provisioner_version=cd1d272

common="
	$repo/kube-proxy-amd64:$kubernetes_version
	$repo/pause:$pause_version
	coredns/coredns:$coredns_version
	weaveworks/weave-kube:$weave_version
	weaveworks/weave-npc:$weave_version
	weaveworks/weaveexec:$weave_version
	docker.io/registry:$registry_version
	docker.io/envoyproxy/envoy-alpine:$envoy_version
	gcr.io/heptio-images/contour:$contour_version
	rook/ceph:$rook_103_version
	rook/ceph:$rook_106_version
	ceph/ceph:$ceph_103_version
	ceph/ceph:$ceph_106_version
	quay.io/replicated/replicated-hostpath-provisioner:$replicated_hostpath_provisioner_version"

control="
	$repo/kube-apiserver-amd64:$kubernetes_version
	$repo/kube-controller-manager-amd64:$kubernetes_version
	$repo/kube-scheduler-amd64:$kubernetes_version
	$repo/etcd-amd64:$etcd_version"

oi() {
	local i="$1"
	digest=$(docker image inspect --format '{{index .RepoDigests 0}}' "${i}")
	echo "${i}@${digest#*@}"
}

list() {
	echo "# autogenerated by:"
	echo "#    $0 $@"
	for i in $pkgs ; do
		oi "$i"
	done
}

tag() {
	for i in $pkgs ; do
		id="$(docker image inspect --format '{{.Id}}' "${i}")"
		echo "docker tag ${id:7:12} ${i}"
	done
}

if [ $# -lt 1 ] ; then
    echo >&2 "Need exactly one of \`control-plane' or \`common'"
    exit 1
fi

case $1 in
    common)        pkgs="$common" ;;
    control-plane) pkgs="$control" ;;
esac

for i in $pkgs ; do
	docker image pull "$i" 1>&2
done

case $2 in
    tag) tag ;;
    *)   list ;;
esac
